<script src="/innate-config.js"></script>
<script src="/colors.js"></script>
<script src="/swears.js"></script>
<script src="/pure.js"></script>

<div class="sections-container">
  <div class="section">
    <div class="section-header" onclick="opensection('favorites')" style="margin-top:10vh;">Favorites</div>
    <div class="section-content" style="border-top:3px solid;" id="favorites">
    </div>
  </div>
  <div class="section">
    <div class="section-header" onclick="opensection('groups')">All</div>
    <div class="section-content" id="groups" style="border-top: 3px solid;border-bottom: 3px solid;">
    </div>
  </div>
</div>

<div id="dms"><div style="display:none;">e</div></div>
<style>
  .sections-container {
      display: flex;
    flex-direction: column;
    width: 100vw;
    margin: 0px;
    padding: 0px;
    position: absolute;
    left: 0px;
    top: 0px;
    height: 100vh;
}

.section-header {
      background-color: var(--button);
    color: var(--primary);
    margin: 0px;
    cursor: pointer;
    height: 5vh;
    text-align: center;
    user-select: none;
    font-size: 2vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.section-content {
    height: 100vh;
    margin: 0px;
  bottom: 0.5vh;
    transition: 0.7s;
  height: 83.5vh;
}

  

  #dms{
    width:100%;
    height:90%;
    position:absolute;
    left:0px;
    bottom:0px;
    overflow-y:scroll;
    overflow-x:hidden;
  }
  .dminput{
    outline: none;
    width: 30%;
    padding: 0.2vh;
    position: absolute;
    right: 10%;
    color: var(--primary);
    background: transparent;
    border-radius: 25px;
    border: 2px solid var(--primary);
    font-size: 2.2vh;
    padding-left: 1vh;
  }
  .dmtext{
    position: relative;
    left: 5px;
    display: flex;
    font-size: 2.5vh;
    color:var(--primary);
  }
  .dmbox{
    height: 5vh;
    display: flex;
    border-bottom: 3px solid var(--primary);
    width: 100%;
    align-items: center;
    padding-top: 5px;
    padding-bottom: 5px;
    flex-direction: row;
    justify-content: space-between;
  }
  .dmbutton:disabled{
    opacity:0.5;
    cursor: default;
  }
  .dmbutton{
    cursor:pointer;
    position: relative;
    right: 5px;
    display: flex;
    background: var(--primary);
    color:var(--bg);
    border: 0px;
    border-radius: 27px;
    float: right;
    font-size: 2.3vh;
    padding-left: 1vh;
    padding-right: 1vh;
    padding-top: 0.6vh;
    padding-bottom: 0.6vh;
  }

  
  body{
    background:var(--bg);
    overflow:hidden;
  }
  ::-webkit-scrollbar {
    width: 10px;
  }

  .passwordcont{
    position: fixed;
    width: 40vh;
    background: var(--container);
    height: 40vh;
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    pointer-events:all;
    flex-direction: column;
    border-radius: 3vh;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
  }

  .paswordhead{
    font-size: 4.5vh;
    color: var(--primary);
    font-weight: 100;
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--primary); 
    border-radius: 10px;
  }
  @keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
  }
  ::-webkit-scrollbar-thumb:hover {
    background: gray; 
  }
  #groups{
    width: 100%;
    height: 90%;
    position: absolute;
    left: 0px;
    bottom: 0px;
    overflow-y: scroll;
    display: ruby;
    text-align: center;
  }
  .passwordinput{
    outline: none;
    width: 25vh;
    padding: 0.2vh;
    color: var(--primary);
    background: transparent;
    border-radius: 25px;
    border: 2px solid var(--primary);
    padding-left: 1vh;
    font-size: 3vh;
  }
  .grouptext{
    font-size: 4vh;
    font-weight: 200;
    text-align: left;
    position: relative;
    top: 5vh;
    color: var(--primary);
  }
  ::placeholder{
    grid-template-co
    color:var(--primary);
  }
  .groupbox{
    min-width: 15vh;
    background: var(--container);
    height: 23vh;
    border-radius: 4.5vh;
    flex-direction: column;
    overflow: hidden;
    display: flex;
    align-items: center;
    margin: 1vh;
    padding-left: 3vh;
    padding-right: 3vh;
    max-width: 30vh;
  }
  .groupbutton:disabled{
    opacity:0.5;
    cursor: default;
  }
  .star{
    width: 3vh;
    align-self: end;
    position: absolute;
    padding-top: 2vh;
    cursor: pointer;
  }
  .groupbutton{
    cursor: pointer;
    background: var(--primary);
    color: var(--bg);
    border: 0px;
    border-radius: 27px;
    font-size: 3vh;
    padding-left: 1vh;
    padding-right: 1vh;
    padding-top: 0.6vh;
    padding-bottom: 0.6vh;
    position: relative;
    top: 10vh;
  }
  .x{
    position: absolute; right: 0px; top: 0px; font-size: 4vh; font-weight: 100; border: 0px; background: transparent; margin: 2vh; cursor:pointer;
  }
  .unread{
    background: red;
    position: absolute;
    height: 2vh;
    width: 2vh;
    display: none;
    border-radius: 50%;
    left: 0.2vw;
  }
</style>
<script defer>
  var clientuser=localStorage.getItem("username");
  var clientpassword=localStorage.getItem("password");

  var starred=localStorage.getItem("starred");
  if (starred){
    starred=JSON.parse(starred);
  } else {
    starred={};
  }
  

  if (clientuser==undefined || clientuser==null){
    window.location.href="/signup";
  }

  var groupPasswords=localStorage.getItem("groupPasswords");
  if (groupPasswords){
    groupPasswords=JSON.parse(groupPasswords);
  } else {
    groupPasswords={};
  }

  function updateStars(){
    var stars=document.getElementsByClassName("star");
    for (var i=0;i<stars.length;i++){
      if (starred[stars[i].parentNode.querySelector(".passwordcont").querySelector(".passwordinput").id]=="yes"){
        stars[i].src="/images/star.png";
      } else {
        stars[i].src="/images/stardark.png";
      }
    }
    localStorage.setItem("starred",JSON.stringify(starred));
  }

  function updatePasswords(){
    if (!groupPasswords[localStorage.getItem("groupname")]){
      groupPasswords[localStorage.getItem("groupname")]={password:""};
    }
    groupPasswords[localStorage.getItem("groupname")].password=localStorage.getItem("grouppassword");
    localStorage.setItem("groupPasswords",JSON.stringify(groupPasswords));
  }
  
  function getText(file){
    return new Promise((resolve) => {
      fetch(file)
        .then((response) => {
          return response.text();
        })
        .then((txt) => {
          resolve(txt.trim());
        });
    });
  }

  function star(element){
    var currentstarred=starred[element.parentNode.querySelector(".passwordcont").querySelector(".passwordinput").id];
    if (currentstarred=="yes"){
      starred[element.parentNode.querySelector(".passwordcont").querySelector(".passwordinput").id]="no";
    } else {
      starred[element.parentNode.querySelector(".passwordcont").querySelector(".passwordinput").id]="yes";
    }
    updateStars();
  }

  async function setTarget(element){
    localStorage.removeItem("groupname");
    localStorage.setItem('targetuser',element.dataset.group);
  }
  
  async function join(element){
    document.getElementById("groups").style.pointerEvents="none";
    var nopassword=await getText(localStorage.getItem("server")+"group.php/?val=v&group="+element.dataset.group+"&password=none");
    nopassword=nopassword.trim();
    if (nopassword!=="Valid"){
      element.parentNode.querySelector('.passwordcont').style.display="flex";
      /*
      var passwordinuse=document.getElementById(element.dataset.group).value;
      var verify=await getText(localStorage.getItem("server")+"group.php/?val=v&group="+element.dataset.group+"&password="+passwordinuse);
      verify = verify.trim();
      if (verify==="Valid"){
        localStorage.removeItem("targetuser");
        localStorage.setItem("groupname",element.dataset.group);
        localStorage.setItem("grouppassword",passwordinuse);
        updatePasswords();
      } else {
        document.getElementById(element.dataset.group).style.animation='shake 0.5s';
        document.getElementById(element.dataset.group).addEventListener('animationend',() => {
            document.getElementById(element.dataset.group).style.animation=null;
          });
      }
      */
    } else {
      localStorage.removeItem("targetuser");
      localStorage.setItem("groupname",element.dataset.group);
      localStorage.setItem("grouppassword","none");
      document.getElementById("groups").style.pointerEvents="all";
    }
  }

  function closePassword(element){
    element.parentNode.style.display='none';
    document.getElementById("groups").style.pointerEvents="all";
  }

  async function finishJoin(element){
    var passwordinuse=element.parentNode.querySelector('input').value;
    var verify=await getText(localStorage.getItem("server")+"group.php/?val=v&group="+element.parentNode.querySelector('input').id+"&password="+passwordinuse);
    verify = verify.trim();
    if (verify==="Valid"){
      localStorage.removeItem("targetuser");
      localStorage.setItem("groupname",element.parentNode.querySelector('input').id);
      localStorage.setItem("grouppassword",passwordinuse);
      updatePasswords();
      document.getElementById("groups").style.pointerEvents="all";
      element.parentNode.style.display="none";
    } else {
      element.parentNode.querySelector('input').style.animation='shake 0.5s';
      element.parentNode.querySelector('input').addEventListener('animationend',() => {
          element.parentNode.querySelector('input').style.animation=null;
        });
    }
  }

  var params=new URLSearchParams(window.location.search);
  if (!params.get("dm")){
    async function start(){
      groups=await getText(localStorage.getItem("server")+"group.php?val=r&group=&password=");
      document.getElementById("dms").style.display="none";
      var grouplines=groups.toString().split("|");
      var groupjson={groups: []};
      for(var i=0;i<grouplines.length-1;i++){
        var tempjson={};
        tempjson.name=grouplines[i];
        groupjson.groups.push(tempjson);
      }
      
      for (var i=0;i<groupjson.groups.length;i++){
        var groupdiv=document.createElement("div");
        groupdiv.className="groupbox";

        if (groupjson.groups[i].name!=localStorage.getItem("groupname")){
          groupdiv.innerHTML="<img class='star' src='/images/stardark.png' onclick='star(this)'><div class='grouptext'>"+filter(groupjson.groups[i].name)+"</div><div class='passwordcont'><h1 class='paswordhead'>Password</h1><input class='passwordinput' placeholder='Password...' type='password' id="+groupjson.groups[i].name+"><button class='groupbutton' onclick='finishJoin(this);' style='top:3vh;'>Join</button><button class='x' onclick='closePassword(this);'>x</button></div><button class='groupbutton' data-group='"+escapeHTML(groupjson.groups[i].name)+"' onclick='join(this);'>Join</button>";
        } else {
          groupdiv.innerHTML="<img class='star' src='/images/stardark.png' onclick='star(this);'><div class='grouptext'>"+filter(groupjson.groups[i].name)+"</div><div class='passwordcont'><h1 class='paswordhead'>Password</h1><input class='passwordinput' placeholder='Password...' type='password' id="+groupjson.groups[i].name+"><button class='groupbutton' onclick='finishJoin(this);' style='top:3vh;'>Join</button><button class='x' onclick='closePassword(this);'>x</button></div><button class='groupbutton' data-group='"+escapeHTML(groupjson.groups[i].name)+"' onclick='join(this);' disabled>Joined</button>";
        }
        document.getElementById("groups").appendChild(groupdiv);

        if (!groupPasswords[groupjson.groups[i].name]){
          groupPasswords[groupjson.groups[i].name]={password:""};
        }

        document.getElementsByClassName("passwordinput")[document.getElementsByClassName("passwordinput").length-1].value=groupPasswords[groupjson.groups[i].name].password;
        /*
        var nopassword=await getText(localStorage.getItem("server")+"group.php/?val=v&group="+groupjson.groups[i].name+"&password=none");
        if (nopassword!="Valid"){
          document.getElementById(groupjson.groups[i].name).style.display="block";
        }*/
      }
      updateStars();
    }
    start();
  } else {
    document.getElementsByClassName("sections-container")[0].style.display="none";

    var dms;
    async function start(){
      dms=await getText(localStorage.getItem("server")+"opendm.php?val=r&currentuser="+clientuser+"&up="+clientpassword+"&targetuser=");
      var dmlines=dms.toString().split("|");
      var dmjson={dms: []};
      for(var i=0;i<dmlines.length-1;i++){
        var tempjson={};
        tempjson.name=dmlines[i];
        dmjson.dms.push(tempjson);
      }
      
      for (var i=0;i<dmjson.dms.length;i++){
        var dmdiv=document.createElement("div");
        dmdiv.className="dmbox";

        if (dmjson.dms[i].name!=localStorage.getItem("targetuser")){
          dmdiv.innerHTML="<div class='unread'></div><div class='dmtext'>"+filter(dmjson.dms[i].name)+"</div><input class='dminput' placeholder='Password...' style='display:none;' type='password' id='"+escapeHTML(dmjson.dms[i].name)+"'><button class='dmbutton' data-group='"+escapeHTML(dmjson.dms[i].name)+"' onclick='setTarget(this);'>Message</button>";
        } else {
          dmdiv.innerHTML="<div class='unread'></div><div class='dmtext'>"+filter(dmjson.dms[i].name)+"</div><input class='dminput' placeholder='Password...' style='display:none;' type='password' id='"+escapeHTML(dmjson.dms[i].name)+"'><button class='dmbutton' data-group='"+escapeHTML(dmjson.dms[i].name)+"' onclick='setTarget(this);' disabled>Messaging</button>";
        }
        document.getElementById("dms").appendChild(dmdiv);

        document.getElementById(dmjson.dms[i].name).style.display="none";
      }
      document.getElementsByClassName("dmbox")[0].style.borderTop="3px solid black";
      
      async function updateDM(){
        var newdm=await getText(localStorage.getItem("server")+"opendm.php?val=r&currentuser="+clientuser+"&up="+clientpassword+"&targetuser=");
        if (newdm!=dms){
          newdm=newdm.replace(dms,"");
          var usertodm=newdm.split("|")[0];
          localStorage.setItem("alert",usertodm+" started a conversation with you.");
          window.location.reload();
        }

        var response=await getText(localStorage.getItem("server")+"unread.php?val=r&currentuser="+clientuser+"&up="+clientpassword);
        var parts=response.split("|");
        var found=false;
        for (var i=0;i<parts.length;i++){
          var segments=parts[i].split(":");
          if (segments[1]=="unread" && segments[0]!=""){
            var users=document.getElementsByClassName("dmtext");
            for (var u=0;u<users.length;u++){
              if (users[u].innerHTML==segments[0]){
                document.getElementsByClassName("unread")[u].style.display="block";
                users[u].style.left="calc(5px + 0.2vw + 2vh)";
                found=true;
                break;
              } else {
                document.getElementsByClassName("unread")[u].style.display="none";
              document.getElementsByClassName("dmtext")[u].style.left="5px";
              }
            }
            if (!found){
              console.log("user "+segments[0]+" not found in DMs.");
            }
          }
        }
      }
      setInterval(updateDM,1000);
    }
    start();
  }


  var sectionHeight="83.5vh";
  
  function opensection(id) {
  if (id=="groups"){
    document.getElementById("favorites").style.height="0vh";
  } else {
    document.getElementById("groups").style.height="0vh";
  }
  var element=document.getElementById(id);
  if (element.style.height == sectionHeight){
      element.style.height="0vh";
      if (id=="groups"){
        document.getElementById("favorites").style.height=sectionHeight;
      } else {
        document.getElementById("groups").style.height=sectionHeight;
      }
  } else {
    element.style.height=sectionHeight;
  }
}

opensection("groups");
</script>
